name: Fuzzing

on:
  # push/pull_request/schedule disabled to conserve GitHub Actions free tier minutes.
  # Re-enable when project is stable or on a paid plan.
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main, develop ]
  # schedule:
  #   - cron: '0 5 * * *'
  workflow_dispatch:

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  fuzz:
    name: Fuzzing Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - encrypt_fuzz
          - cross_border_fuzz
          - hybrid_kem_fuzz
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # nightly

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Cache Cargo registry
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-fuzz-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build fuzz targets
      run: |
        cd fuzz
        cargo fuzz build

    - name: Run fuzz tests (short duration)
      run: |
        cd fuzz
        timeout 300s cargo fuzz run ${{ matrix.target }} -- -max_total_time=300 || true

    - name: Upload fuzz artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      if: failure()
      with:
        name: fuzz-artifacts-${{ matrix.target }}
        path: fuzz/artifacts/
        retention-days: 7

  extended-fuzz:
    name: Extended Fuzzing
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    strategy:
      matrix:
        target:
          - encrypt_fuzz
          - cross_border_fuzz
          - hybrid_kem_fuzz
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # nightly

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Cache Cargo registry
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-extended-fuzz-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run extended fuzz tests
      run: |
        cd fuzz
        timeout 3600s cargo fuzz run ${{ matrix.target }} -- -max_total_time=3600 || true

    - name: Upload extended fuzz artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      if: failure()
      with:
        name: extended-fuzz-artifacts-${{ matrix.target }}
        path: fuzz/artifacts/
        retention-days: 7

  fuzz-coverage:
    name: Fuzzing Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # nightly
      with:
        components: llvm-tools-preview

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@1c0532667bd5bc37f71fc223a52e7c41c966d9d7 # main
      with:
        tool: cargo-llvm-cov

    - name: Cache Cargo registry
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-fuzz-coverage-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run fuzz with coverage
      run: |
        cd fuzz
        # First, run fuzzer briefly to generate corpus inputs
        timeout 60s cargo fuzz run encrypt_fuzz -- -max_total_time=60 || true
        # Then generate coverage from the corpus (may fail if corpus is empty)
        cargo fuzz coverage encrypt_fuzz -- -max_total_time=60 || echo "Fuzz coverage skipped (no corpus)"

    - name: Upload fuzz coverage
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: fuzz-coverage
        path: fuzz/coverage/
        retention-days: 30

  fuzz-report:
    name: Fuzzing Report
    runs-on: ubuntu-latest
    needs: [fuzz, extended-fuzz, fuzz-coverage]
    if: always()
    steps:
    - name: Generate fuzzing summary
      run: |
        echo "# Fuzzing Report Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Fuzzing Tests | ${{ needs.fuzz.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Extended Fuzzing | ${{ needs.extended-fuzz.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Fuzzing Coverage | ${{ needs.fuzz-coverage.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Check overall status
      run: |
        if [[ "${{ needs.fuzz.result }}" == "failure" ]]; then
          echo "❌ Fuzzing tests failed!"
          exit 1
        else
          echo "✅ Fuzzing tests passed!"
        fi