# Mutation Testing
# Validates test suite effectiveness by injecting bugs and checking if tests catch them
# Each job targets a specific module within the consolidated latticearc crate

name: Mutation Testing

on:
  # Schedule will be enabled once the library is stable and usage increases.
  # schedule:
  #   - cron: '0 6 * * 0'  # Weekly on Sunday at 6 AM UTC
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to test (comma-separated, or "all")'
        required: false
        default: 'latticearc'
        type: string
      timeout:
        description: 'Timeout per mutant (seconds)'
        required: false
        default: '300'
        type: string

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # Mutation testing for primitives module (KEM, signatures, AEAD, hash, KDF)
  mutate-primitives:
    name: Mutate primitives module
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Cache Cargo registry
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-mutation-primitives-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-mutants
        run: cargo install cargo-mutants

      - name: Run mutation testing on primitives module
        run: |
          cargo mutants -p latticearc \
            --file "latticearc/src/primitives/**/*.rs" \
            --timeout ${{ inputs.timeout || '300' }} \
            --jobs 2 \
            --output mutants-primitives \
            2>&1 | tee mutation-primitives.log
        continue-on-error: true

      - name: Generate mutation report
        if: always()
        run: |
          echo "## Mutation Testing: latticearc::primitives" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "mutants-primitives/outcomes.json" ]; then
            CAUGHT=$(jq '[.outcomes[] | select(.outcome == "Caught")] | length' mutants-primitives/outcomes.json 2>/dev/null || echo "0")
            MISSED=$(jq '[.outcomes[] | select(.outcome == "Missed")] | length' mutants-primitives/outcomes.json 2>/dev/null || echo "0")
            TIMEOUT=$(jq '[.outcomes[] | select(.outcome == "Timeout")] | length' mutants-primitives/outcomes.json 2>/dev/null || echo "0")
            TOTAL=$((CAUGHT + MISSED + TIMEOUT))

            if [ "$TOTAL" -gt 0 ]; then
              SCORE=$(echo "scale=1; $CAUGHT * 100 / $TOTAL" | bc)
              echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Mutants Caught | $CAUGHT |" >> $GITHUB_STEP_SUMMARY
              echo "| Mutants Missed | $MISSED |" >> $GITHUB_STEP_SUMMARY
              echo "| Timeouts | $TIMEOUT |" >> $GITHUB_STEP_SUMMARY
              echo "| **Mutation Score** | **${SCORE}%** |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No mutation results available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload mutation results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: mutation-primitives
          path: |
            mutants-primitives/
            mutation-primitives.log
          retention-days: 30

  # Mutation testing for unified_api module (CryptoConfig, encrypt/decrypt, signatures)
  mutate-unified-api:
    name: Mutate unified_api module
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Cache Cargo registry
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-mutation-unified-api-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-mutants
        run: cargo install cargo-mutants

      - name: Run mutation testing on unified_api module
        run: |
          cargo mutants -p latticearc \
            --file "latticearc/src/unified_api/**/*.rs" \
            --timeout ${{ inputs.timeout || '300' }} \
            --jobs 2 \
            --output mutants-unified-api \
            2>&1 | tee mutation-unified-api.log
        continue-on-error: true

      - name: Generate mutation report
        if: always()
        run: |
          echo "## Mutation Testing: latticearc::unified_api" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "mutants-unified-api/outcomes.json" ]; then
            CAUGHT=$(jq '[.outcomes[] | select(.outcome == "Caught")] | length' mutants-unified-api/outcomes.json 2>/dev/null || echo "0")
            MISSED=$(jq '[.outcomes[] | select(.outcome == "Missed")] | length' mutants-unified-api/outcomes.json 2>/dev/null || echo "0")
            TIMEOUT=$(jq '[.outcomes[] | select(.outcome == "Timeout")] | length' mutants-unified-api/outcomes.json 2>/dev/null || echo "0")
            TOTAL=$((CAUGHT + MISSED + TIMEOUT))

            if [ "$TOTAL" -gt 0 ]; then
              SCORE=$(echo "scale=1; $CAUGHT * 100 / $TOTAL" | bc)
              echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Mutants Caught | $CAUGHT |" >> $GITHUB_STEP_SUMMARY
              echo "| Mutants Missed | $MISSED |" >> $GITHUB_STEP_SUMMARY
              echo "| Timeouts | $TIMEOUT |" >> $GITHUB_STEP_SUMMARY
              echo "| **Mutation Score** | **${SCORE}%** |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No mutation results available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload mutation results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: mutation-unified-api
          path: |
            mutants-unified-api/
            mutation-unified-api.log
          retention-days: 30

  # Mutation testing for hybrid module (hybrid encryption + signatures)
  mutate-hybrid:
    name: Mutate hybrid module
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Cache Cargo registry
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-mutation-hybrid-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-mutants
        run: cargo install cargo-mutants

      - name: Run mutation testing on hybrid module
        run: |
          cargo mutants -p latticearc \
            --file "latticearc/src/hybrid/**/*.rs" \
            --timeout ${{ inputs.timeout || '300' }} \
            --jobs 2 \
            --output mutants-hybrid \
            2>&1 | tee mutation-hybrid.log
        continue-on-error: true

      - name: Generate mutation report
        if: always()
        run: |
          echo "## Mutation Testing: latticearc::hybrid" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "mutants-hybrid/outcomes.json" ]; then
            CAUGHT=$(jq '[.outcomes[] | select(.outcome == "Caught")] | length' mutants-hybrid/outcomes.json 2>/dev/null || echo "0")
            MISSED=$(jq '[.outcomes[] | select(.outcome == "Missed")] | length' mutants-hybrid/outcomes.json 2>/dev/null || echo "0")
            TIMEOUT=$(jq '[.outcomes[] | select(.outcome == "Timeout")] | length' mutants-hybrid/outcomes.json 2>/dev/null || echo "0")
            TOTAL=$((CAUGHT + MISSED + TIMEOUT))

            if [ "$TOTAL" -gt 0 ]; then
              SCORE=$(echo "scale=1; $CAUGHT * 100 / $TOTAL" | bc)
              echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Mutants Caught | $CAUGHT |" >> $GITHUB_STEP_SUMMARY
              echo "| Mutants Missed | $MISSED |" >> $GITHUB_STEP_SUMMARY
              echo "| Timeouts | $TIMEOUT |" >> $GITHUB_STEP_SUMMARY
              echo "| **Mutation Score** | **${SCORE}%** |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No mutation results available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload mutation results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: mutation-hybrid
          path: |
            mutants-hybrid/
            mutation-hybrid.log
          retention-days: 30

  # Summary job
  mutation-summary:
    name: Mutation Summary
    runs-on: ubuntu-latest
    needs: [mutate-primitives, mutate-unified-api, mutate-hybrid]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Mutation Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Mutation testing validates test suite effectiveness by:" >> $GITHUB_STEP_SUMMARY
          echo "1. Introducing small bugs (mutants) into the code" >> $GITHUB_STEP_SUMMARY
          echo "2. Running tests to see if they catch the bugs" >> $GITHUB_STEP_SUMMARY
          echo "3. Computing a mutation score (% of mutants caught)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results by Module" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| latticearc::primitives | ${{ needs.mutate-primitives.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| latticearc::unified_api | ${{ needs.mutate-unified-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| latticearc::hybrid | ${{ needs.mutate-hybrid.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Target" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Goal**: >70% mutation score for critical crypto code" >> $GITHUB_STEP_SUMMARY
          echo "- **Interpretation**: Higher scores mean better test coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Missed mutants indicate areas where tests could be improved." >> $GITHUB_STEP_SUMMARY
