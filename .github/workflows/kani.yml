# Kani - Bounded Model Checking
# Proves absence of panics, overflow, and out-of-bounds access in pure Rust code.
#
# arc-types contains 12 proofs covering:
#   - Key lifecycle state machine (SP 800-57 compliance)
#   - Crypto policy engine exhaustiveness (all enum variants handled)
#   - Trust level ordering invariants
#   - Security level defaults

name: Kani Model Checking

on:
  schedule:
    - cron: '0 3 * * *'  # Nightly at 3 AM UTC (low traffic)
    - cron: '0 5 * * 0'  # Weekly Sunday at 5 AM UTC (full suite)
  workflow_dispatch:     # Keep manual trigger
  push:
    branches: [main]     # Run on main branch merges (release validation)
    paths:
      - 'arc-types/src/**'          # Re-run if arc-types changes

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # Tier 1: Pure Rust proofs that MUST pass — badge reflects this job
  kani-verified:
    name: Verified Proofs (arc-types)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Kani
        run: |
          cargo install --locked kani-verifier
          kani setup

      - name: Cache Kani
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.kani
          key: ${{ runner.os }}-kani-verified-${{ hashFiles('**/Cargo.lock') }}

      - name: Run verified Kani proofs (arc-types)
        run: |
          set -o pipefail
          cargo kani -p arc-types 2>&1 | tee kani-output.txt
        timeout-minutes: 120

      - name: Upload Kani results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: kani-verified-results
          path: kani-output.txt
          retention-days: 30

      - name: Verified Proofs Summary
        if: always()
        run: |
          echo "## Kani Proofs (arc-types) — 12 proofs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ! -f kani-output.txt ]; then
            echo "⚠️ No Kani output file — step may have been skipped" >> $GITHUB_STEP_SUMMARY
          elif grep -q "VERIFICATION:- SUCCESSFUL" kani-output.txt; then
            echo "✅ All proofs verified successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Key Lifecycle (5 proofs — SP 800-57):**" >> $GITHUB_STEP_SUMMARY
            echo "- \`key_state_machine_transitions_match_spec\`: Transitions match SP 800-57" >> $GITHUB_STEP_SUMMARY
            echo "- \`key_state_machine_destroyed_cannot_transition\`: Destroyed keys reject all transitions" >> $GITHUB_STEP_SUMMARY
            echo "- \`key_state_machine_no_backward_to_generation\`: No backward transitions" >> $GITHUB_STEP_SUMMARY
            echo "- \`key_state_machine_only_generation_from_none\`: Initial state must be Generation" >> $GITHUB_STEP_SUMMARY
            echo "- \`key_state_machine_retired_only_to_destroyed\`: Retired → Destroyed only" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Policy Engine (3 proofs):**" >> $GITHUB_STEP_SUMMARY
            echo "- \`force_scheme_covers_all_variants\`: All CryptoScheme variants handled" >> $GITHUB_STEP_SUMMARY
            echo "- \`select_pq_encryption_covers_all_levels\`: PQ encryption for all SecurityLevels" >> $GITHUB_STEP_SUMMARY
            echo "- \`select_pq_signature_covers_all_levels\`: PQ signatures for all SecurityLevels" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Zero Trust (3 proofs):**" >> $GITHUB_STEP_SUMMARY
            echo "- \`trust_level_ordering_total\`: Total ordering on TrustLevel" >> $GITHUB_STEP_SUMMARY
            echo "- \`trust_level_is_trusted_iff_at_least_partial\`: is_trusted() ↔ level ≥ Partial" >> $GITHUB_STEP_SUMMARY
            echo "- \`trust_level_untrusted_is_minimum\`: Untrusted is minimum" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Types (1 proof):**" >> $GITHUB_STEP_SUMMARY
            echo "- \`security_level_default_is_high\`: Default SecurityLevel is High (NIST Level 3)" >> $GITHUB_STEP_SUMMARY
          elif grep -q "VERIFICATION:- FAILED" kani-output.txt; then
            echo "❌ Some proofs failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Proofs" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -A5 "VERIFICATION:- FAILED" kani-output.txt >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Unexpected Kani output — review the artifact for details" >> $GITHUB_STEP_SUMMARY
          fi

  kani-summary:
    name: Kani Summary
    runs-on: ubuntu-latest
    needs: [kani-verified]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Kani Model Checking Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Kani uses bounded model checking to prove the absence of:" >> $GITHUB_STEP_SUMMARY
          echo "- Panics and assertion failures" >> $GITHUB_STEP_SUMMARY
          echo "- Arithmetic overflow/underflow" >> $GITHUB_STEP_SUMMARY
          echo "- Out-of-bounds array access" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid memory access" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## arc-types (12 proofs, pure Rust)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Proofs | What they verify |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Key Lifecycle | 5 | SP 800-57 state machine transitions |" >> $GITHUB_STEP_SUMMARY
          echo "| Policy Engine | 3 | Scheme selection covers all enum variants |" >> $GITHUB_STEP_SUMMARY
          echo "| Zero Trust | 3 | TrustLevel ordering invariants |" >> $GITHUB_STEP_SUMMARY
          echo "| Types | 1 | SecurityLevel default is High |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| arc-types | ${{ needs.kani-verified.result }} |" >> $GITHUB_STEP_SUMMARY
