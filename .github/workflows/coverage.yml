name: Coverage

on:
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 4 * * 1'  # Weekly on Monday at 4 AM UTC
  workflow_dispatch:

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUST_MIN_STACK: 16777216

jobs:
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        submodules: recursive

    - name: Install Rust
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@80e1af6735e72e84f33517a81b7d524165116b99 # main
      with:
        tool: cargo-llvm-cov

    - name: Cache Cargo registry
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-coverage-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Generate coverage with llvm-cov
      run: |
        # Generate LCOV format for Codecov
        cargo llvm-cov --workspace --all-features --release --lcov --output-path lcov.info
        # Generate HTML report separately
        cargo llvm-cov --workspace --all-features --release --html

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
      with:
        files: lcov.info
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage reports
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: coverage-reports
        path: |
          target/llvm-cov/html/
        retention-days: 30

  coverage-check:
    name: Coverage Threshold Check
    runs-on: ubuntu-latest
    needs: coverage
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Install Rust
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@80e1af6735e72e84f33517a81b7d524165116b99 # main
      with:
        tool: cargo-llvm-cov

    - name: Cache Cargo registry
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-coverage-check-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check coverage thresholds
      run: |
        
        # Generate coverage and check thresholds
        cargo llvm-cov --workspace --all-features --release --text > coverage.txt
        
        # Extract coverage percentage
        COVERAGE=$(grep "Total:" coverage.txt | awk '{print $2}' | sed 's/%//')
        echo "Current coverage: ${COVERAGE}%"
        
        # Check if coverage meets minimum threshold (80%)
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "❌ Coverage ${COVERAGE}% is below minimum threshold of 80%"
          exit 1
        else
          echo "✅ Coverage ${COVERAGE}% meets minimum threshold of 80%"
        fi

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [coverage, coverage-check]
    if: always()
    steps:
    - name: Generate coverage summary
      run: |
        echo "# Coverage Report Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Coverage Generation | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Coverage Threshold | ${{ needs.coverage-check.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Check overall status
      run: |
        if [[ "${{ needs.coverage.result }}" == "failure" || \
              "${{ needs.coverage-check.result }}" == "failure" ]]; then
          echo "❌ Coverage checks failed!"
          exit 1
        else
          echo "✅ Coverage checks passed!"
        fi